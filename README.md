# Player Metrics Stored Procedure

## Overview
This repository contains a SQL stored procedure that prepares a dataset for tracking player activity on a monthly basis. The dataset is designed for Tableau reporting and classifies players into four categories:

- **New Players**: Players who made their first deposit in the current month.
- **Retained Players**: Players who deposited both in the current and the previous month.
- **Reactivated Players**: Players who deposited in the current month, skipped the previous month, but had deposited in the past.
- **Churned Players**: Players who deposited in the previous month but did not deposit in the current month.

## Data Processing Logic
The stored procedure:
1. **Drops and recreates the table** that stores the player metrics.
2. **Generates a list of the last 12 complete months** as a reference period.
3. **Identifies all unique depositing players** in the last 12 months.
4. **Associates each player with each month** to ensure all player-month combinations are considered.
5. **Aggregates deposit transaction data** for each player-month combination.
6. **Calculates key player metrics**, including lifetime deposits, deposits in previous months, and the classification flags (new, retained, reactivated, churned).
7. **Stores the processed dataset in a structured table**, which is then available for Tableau reporting.

## Execution Schedule
- The stored procedure should be executed **once per month**, on the **1st of the month**, to process data for the **previous complete month**.
- The dataset maintains **12 full months of history**, ensuring that reports always reflect a rolling one-year window.

## Table Structure
| Column Name                     | Data Type       | Description |
|----------------------------------|----------------|-------------|
| `PlayerID`                      | `INT`          | Unique player identifier. |
| `SiteID`                        | `INT`          | Identifier for the gaming site. |
| `Site`                          | `NVARCHAR(255)`| Name of the gaming site. |
| `MonthStart`                    | `DATE`         | The start of the reporting month. |
| `transactions_created`           | `INT`          | Number of deposits in the month. |
| `transactions_created_lifetime`  | `INT`          | Total deposits made by the player up to the current month. |
| `transactions_created_prev`      | `INT`          | Deposits made in the previous month. |
| `transactions_created_prev_2`    | `INT`          | Deposits made two months ago. |
| `new_flag`                       | `BIT`          | 1 if the player deposited for the first time in the current month. |
| `churns_flag`                    | `BIT`          | 1 if the player deposited last month but not in the current month. |
| `reactivations_flag`             | `BIT`          | 1 if the player deposited this month but skipped the previous month. |
| `retentions_flag`                | `BIT`          | 1 if the player deposited both in the current and previous month. |

## Usage in Tableau
The dataset generated by this stored procedure is structured for seamless integration with **Tableau**, allowing for visualization of player trends over time. Suggested Tableau reports include:

- **Monthly Player Classification Dashboard**
  - A time-series breakdown of new, retained, reactivated, and churned players.
  - Site-level filtering to compare player retention across different platforms.
  
- **Cohort Analysis**
  - Analyzing player lifecycle behavior over multiple months.
  - Understanding the reactivation rate of previously churned players.
  
## Installation & Execution
### Running the Stored Procedure
To execute the stored procedure, use the following SQL command:
```sql
EXEC [YourSchema].[sp_CalculatePlayerMetrics];
```
This will generate and store the dataset for Tableau consumption.

### Automating Execution
To ensure the dataset is updated on time each month, schedule the stored procedure using SQL Server Agent:
1. **Create a new SQL Agent job**.
2. **Set the job schedule** to run on the 1st of each month.
3. **Add a job step** with the command:
   ```sql
   EXEC [YourSchema].[sp_CalculatePlayerMetrics];
   ```
4. **Save and enable** the job.

## Contributions & Feedback
If you have suggestions for improving this dataset or additional metrics to track, feel free to open an issue or submit a pull request.

---
**Maintainer:** Anastasiia

